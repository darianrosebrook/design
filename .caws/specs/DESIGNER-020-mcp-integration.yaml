id: DESIGNER-020
title: 'MCP Bridge Integration for Agent Workflows'
risk_tier: 2
mode: feature
change_budget:
  max_files: 25
  max_loc: 1000
blast_radius:
  modules:
    - packages/mcp-adapter/
    - packages/vscode-ext/src/
    - packages/vscode-ext/webviews/canvas/
  data_migration: false
operational_rollback_slo: 15m
threats:
  - 'MCP server spawn leaks processes when webview closes'
  - 'Unauthenticated requests mutate documents outside workspace'
  - 'Concurrent MCP edits conflict with local changes'
  - 'Webview hangs waiting on MCP responses'
  - 'Agent-produced mutations bypass validation and break determinism'
scope:
  in:
    - packages/mcp-adapter/src/
    - packages/vscode-ext/src/mcp/
    - packages/vscode-ext/webviews/canvas/
    - packages/canvas-engine/src/operations.ts
  out:
    - packages/canvas-renderer-dom/
    - packages/design-tokens/
invariants:
  - 'MCP requests validated against protocol schemas before execution'
  - 'MCP bridge enforces workspace-only file access and path whitelisting'
  - 'Document mutations initiated by agents reuse deterministic pipeline'
  - 'Feature flag gates MCP bridge and defaults to disabled'
  - 'Child process lifecycle managed with explicit spawn/kill tied to webview'
  - 'Telemetry emitted for every agent mutation, including provenance ID'
acceptance:
  - id: A1
    given: 'Agent issues loadDocument MCP call'
    when: 'Bridge forwards request'
    then: 'Response returns canonical document snapshot from DocumentStore'
  - id: A2
    given: 'Agent issues updateNode MCP call'
    when: 'Mutation processed through document pipeline'
    then: 'Canvas re-renders and determinism hash remains stable'
  - id: A3
    given: 'MCP server becomes unresponsive'
    when: 'Timeout exceeded'
    then: 'Bridge terminates request, logs warning, and keeps UI responsive'
  - id: A4
    given: 'Agent attempts to access file outside workspace root'
    when: 'Bridge validates path'
    then: 'Request rejected with security error'
  - id: A5
    given: 'Webview closed by user'
    when: 'Bridge handles disposal'
    then: 'Child process terminated and resources released within 5s'
  - id: A6
    given: 'Agent issues conflicting edits while user edits locally'
    when: 'Bridge queues operations'
    then: 'Conflicts resolved deterministically with optimistic locking or user prompt'
non_functional:
  a11y:
    - 'Visual feedback for agent operations uses ARIA live regions'
    - 'Loading indicators communicate progress to assistive tech'
  perf:
    mcp_request_roundtrip_ms: 100
    agent_mutation_apply_ms: 10
    additional:
      - 'Concurrent MCP operations limited to 4 in-flight requests'
      - 'Process spawn completes within 500ms'
      - 'Bridge adds <10ms overhead per request'
      - 'Backpressure kicks in when queue exceeds 10 pending operations'
  security:
    - 'Sanitize logs to exclude sensitive file paths'
    - 'Use feature flag `designer.mcp.enabled` defaulting to false'
    - 'Enforce signed binary checksums before spawning MCP process'
contracts:
  - type: typescript
    path: packages/mcp-adapter/src/types.ts
  - type: typescript
    path: packages/vscode-ext/src/protocol/mcp.ts
observability:
  logs:
    - 'mcp_bridge.request with tool name and duration'
    - 'mcp_bridge.error with sanitized message and code'
    - 'mcp_bridge.spawn with process id and binary path'
    - 'mcp_bridge.shutdown with exit code'
    - 'mcp_bridge.conflict with agent id and resolution path'
  metrics:
    - 'mcp_requests_total counter by tool and status'
    - 'mcp_request_duration_ms histogram'
    - 'mcp_concurrent_requests gauge'
    - 'mcp_agent_mutations_total counter'
    - 'mcp_conflicts_total counter'
  traces:
    - 'mcp_bridge.request lifecycle from receive to respond'
    - 'mcp_bridge.mutation pipeline from MCP event to document update'
    - 'mcp_bridge.process lifecycle from spawn to exit'
migrations:
  - 'No storage migrations required'
rollback:
  - 'Disable MCP bridge via feature flag to revert to manual workflows'
  - 'Kill all MCP processes on deactivate to ensure clean rollback'
  - 'Provide CLI command to purge agent-initiated edits if required'
  - 'Fallback to read-only agent mode when mutation queue detects repeated conflicts'

